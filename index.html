<!DOCTYPE html>
<html>
<head>
    <title>小红书内容抓取</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        button {
            background-color: #ff2442;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:disabled {
            background-color: #cccccc;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            background-color: white;
            border-bottom: 1px solid #ddd;
        }
        .table-container {
            position: relative;
            max-height: calc(100vh - 100px);
            overflow: auto;
        }
        .table-header {
            position: sticky;
            top: 0;
            z-index: 99;
            background-color: #ff2442;
        }
        .table-header th {
            background-color: #ff2442;
            color: white;
            position: sticky;
            top: 0;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            background-clip: padding-box;
        }
        thead th {
            border-bottom: 2px solid #ff3a54;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .stat-item {
            flex: 1;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff2442;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .export-options {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .export-options.show {
            display: block;
        }
        
        .export-option {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .export-option:hover {
            background-color: #f5f5f5;
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            border: 2px solid #ff2442;
            border-radius: 4px;
            font-size: 16px;
            outline: none;
        }
        
        .search-input:focus {
            box-shadow: 0 0 5px rgba(255, 36, 66, 0.3);
        }
        
        #tableBody tr {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }
        
        .cookie-container {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .cookie-header {
            padding: 10px 15px;
            background-color: #f8f9fa;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid #ddd;
        }

        .cookie-header h3 {
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .cookie-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .cookie-content {
            padding: 15px;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 1000px;
            opacity: 1;
            overflow: hidden;
        }

        .cookie-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 15px;
        }

        .cookie-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .cookie-input {
            padding: 8px;
            border: 1px solid #ff2442;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }

        .cookie-input.cookie-string {
            width: 400px;
        }

        .cookie-input.cookie-note {
            width: 150px;
        }

        .cookie-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .cookie-btn:hover {
            background-color: #218838;
        }
        
        .cookie-status {
            font-size: 14px;
            margin-top: 5px;
        }
        
        .cookie-status.success {
            color: #28a745;
        }
        
        .cookie-status.error {
            color: #dc3545;
        }
        
        .cookie-btn.clear {
            background-color: #dc3545;
        }
        
        .cookie-btn.clear:hover {
            background-color: #c82333;
        }
        
        .cookie-list {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .cookie-items {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .cookie-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cookie-item:last-child {
            border-bottom: none;
        }
        
        .cookie-name {
            font-weight: bold;
            color: #333;
        }
        
        .cookie-value {
            color: #666;
            margin-left: 10px;
            word-break: break-all;
        }

        .cookie-group {
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 10px;
        }

        .cookie-group:last-child {
            margin-bottom: 0;
        }

        .cookie-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cookie-group-header span {
            font-weight: 500;
            color: #333;
        }

        .delete-cookie-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-cookie-btn:hover {
            background-color: #c82333;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            background-color: #ff3a54;
        }

        .sort-icon {
            display: inline-block;
            margin-left: 5px;
            transition: transform 0.2s;
        }

        .sort-asc .sort-icon {
            transform: rotate(180deg);
        }

        th.sorting {
            position: relative;
        }

        th.sorting:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #fff;
        }

        .button-group button {
            margin-right: 10px;
        }

        #stopButton {
            background-color: #dc3545;
        }

        #stopButton:hover {
            background-color: #c82333;
        }

        #stopButton:disabled {
            background-color: #cccccc;
        }

        .loading {
            display: inline-block;
            position: relative;
            padding-right: 24px;
        }

        .loading:after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid #ff2442;
            border-radius: 50%;
            border-right-color: transparent;
            animation: rotate 0.8s linear infinite;
        }

        @keyframes rotate {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }

        .search-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sort-select {
            padding: 10px;
            border: 2px solid #ff2442;
            border-radius: 4px;
            font-size: 16px;
            outline: none;
            background-color: white;
            cursor: pointer;
        }
        
        .sort-select:focus {
            box-shadow: 0 0 5px rgba(255, 36, 66, 0.3);
        }

        .table-filter {
            margin-bottom: 15px;
            max-width: 300px;
        }
        
        .filter-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ff2442;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        
        .filter-input:focus {
            box-shadow: 0 0 5px rgba(255, 36, 66, 0.3);
        }

        .cookie-select {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .cookie-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .cookie-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }

        .row-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        #selectAll {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .table-actions {
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            padding: 10px;
        }

        .action-checkboxes {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .action-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .action-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .action-label:hover {
            color: #ff2442;
        }

        .action-checkbox:checked + span {
            color: #ff2442;
            font-weight: bold;
        }

        .action-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-run-btn {
            background-color: #ff2442;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .action-run-btn:hover {
            background-color: #e60026;
        }

        .action-run-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-stop-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .action-stop-btn:hover {
            background-color: #c82333;
        }

        .action-stop-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .run-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .run-times-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ff2442;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }

        .run-times-input:focus {
            box-shadow: 0 0 5px rgba(255, 36, 66, 0.3);
        }

        .run-times-input::-webkit-inner-spin-button,
        .run-times-input::-webkit-outer-spin-button {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>小红书内容抓取</h1>
        <!-- 修改 cookie 功能区 -->
        <div class="cookie-container">
            <div class="cookie-header" onclick="toggleCookieSection()">
                <h3>Cookie 管理 <span class="toggle-icon">▼</span></h3>
            </div>
            <div class="cookie-content" id="cookieContent">
                <div class="cookie-input-group">
                    <input type="text" id="cookieInput" placeholder="请输入小红书 cookie" class="cookie-input cookie-string">
                    <input type="text" id="cookieNote" placeholder="备注（可选）" class="cookie-input cookie-note">
                    <button onclick="saveCookie()" class="cookie-btn">保存 Cookie</button>
                    <button onclick="clearCookie()" class="cookie-btn clear">清除 Cookie</button>
                </div>
                <div id="cookieStatus" class="cookie-status"></div>
                <div class="cookie-list">
                    <h3>当前 Cookie 列表：</h3>
                    <div id="cookieList" class="cookie-items"></div>
                </div>
            </div>
        </div>
        <div class="search-container">
            <div class="search-group">
                <input type="text" id="keywordInput" placeholder="输入搜索关键词" class="search-input">
                <select id="sortType" class="sort-select">
                    <option value="general">综合</option>
                    <option value="newest">最新</option>
                    <option value="hot">最热</option>
                </select>
            </div>
        </div>
        <div class="button-group">
            <button id="startButton" onclick="startScrape()">开始抓取</button>
            <button id="stopButton" onclick="stopScrape()" disabled>停止抓取</button>
            <button id="exportButton" onclick="exportData()" disabled>导出数据</button>
            <button id="importButton" onclick="importData()">导入数据</button>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">总文章数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="currentPage">0</div>
                <div class="stat-label">当前页面</div>
            </div>
        </div>
        <div id="status"></div>

        <div class="table-container">
            <div class="table-filter">
                <input type="text" id="tableFilter" placeholder="筛选关键词" class="filter-input">
            </div>
            <div class="table-actions">
                <div class="action-wrapper">
                    <div class="action-checkboxes">
                        <label class="action-label">
                            <input type="checkbox" id="followAction" class="action-checkbox">
                            <span>关注</span>
                        </label>
                        <label class="action-label">
                            <input type="checkbox" id="likeAction" class="action-checkbox">
                            <span>点赞</span>
                        </label>
                        <label class="action-label">
                            <input type="checkbox" id="favoriteAction" class="action-checkbox">
                            <span>收藏</span>
                        </label>
                        <!-- <label class="action-label">
                            <input type="checkbox" id="commentAction" class="action-checkbox">
                            <span>评论</span>
                        </label> -->
                    </div>
                    <div class="action-buttons">
                        <div class="run-controls">
                            <button id="runActionsButton" onclick="runSelectedActions()" class="action-run-btn">开始运行</button>
                            <button id="stopActionsButton" onclick="stopSelectedActions()" class="action-stop-btn" disabled>停止运行</button>
                        </div>
                    </div>
                </div>
            </div>
            <table id="dataTable">
                <thead class="table-header">
                    <tr>
                        <th class="checkbox-column">
                            <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                        </th>
                        <th>序号</th>
                        <th>标题</th>
                        <th>作者</th>
                        <th class="sortable" onclick="sortTable('likes')">
                            点赞数 
                            <span class="sort-icon">↕</span>
                        </th>
                        <th>链接</th>
                        <th>时间</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let currentArticles = [];
        
        let currentSort = {
            column: null,
            ascending: true
        };
        
        let isScrapingStopped = false;
        
        function startScrape() {
            // 先检查是否有 cookie
            const cookieList = document.getElementById('cookieList');
            if (cookieList.innerHTML.includes('暂无 Cookie')) {
                document.getElementById('status').innerHTML = '请先添加 Cookie 后再开始抓取';
                document.getElementById('status').className = 'error';
                return;
            }

            const keyword = document.getElementById('keywordInput').value.trim();
            const sortType = document.getElementById('sortType').value;
            
            // 获取选中的 cookie 索引
            const selectedCheckbox = document.querySelector('.cookie-checkbox:checked');
            const cookieIndex = selectedCheckbox ? parseInt(selectedCheckbox.getAttribute('data-index')) : 0;
            
            if (!keyword) {
                document.getElementById('status').innerHTML = '请输入搜索关键词';
                document.getElementById('status').className = 'error';
                return;
            }

            isScrapingStopped = false;
            document.getElementById('stopButton').disabled = false;
            document.getElementById('startButton').disabled = true;
            
            const status = document.getElementById('status');
            const tableBody = document.getElementById('tableBody');
            
            status.innerHTML = '正在抓取中...';
            status.className = '';
            tableBody.innerHTML = '';
            currentArticles = [];
            
            document.getElementById('totalCount').textContent = '0';
            document.getElementById('currentPage').textContent = '0';
            
            // 发送包含关键词、排序类型和选中的 cookie 索引的数据
            ipcRenderer.send('start-scrape', {
                keyword: keyword,
                sortType: sortType,
                cookieIndex: cookieIndex
            });
        }

        // 修改新文章事件监听器
        ipcRenderer.on('new-articles', (event, articles) => {
            console.log('收到新文章数据:', articles.length);
            // 重置排序状态
            currentSort = {
                column: null,
                ascending: true
            };
            // 更新数据和表格
            currentArticles = articles;
            updateTable(articles);
        });

        // 修改排序数
        function sortTable(column) {
            // 检查数据是否存在
            if (!currentArticles || !Array.isArray(currentArticles) || currentArticles.length === 0) {
                console.log('没有数据可供排序');
                return;
            }

            console.log('开始排序，数据量:', currentArticles.length);

            // 保存当前选中状态
            const checkedStates = Array.from(document.querySelectorAll('.row-checkbox')).map(checkbox => {
                return {
                    index: parseInt(checkbox.closest('tr').querySelector('td:nth-child(2)').textContent) - 1,
                    checked: checkbox.checked
                };
            });

            // 更新排序状态
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = true;
            }

            // 更新排序图标
            const th = document.querySelector(`th[onclick="sortTable('${column}')"]`);
            document.querySelectorAll('th').forEach(header => {
                header.classList.remove('sort-asc', 'sorting');
            });
            th.classList.add('sorting');
            if (!currentSort.ascending) {
                th.classList.add('sort-asc');
            }

            try {
                // 创建数组副本进行排序
                let articles = [...currentArticles];
                
                // 执行排序
                articles.sort((a, b) => {
                    const valueA = parseInt(a.likes) || 0;
                    const valueB = parseInt(b.likes) || 0;
                    return currentSort.ascending ? valueA - valueB : valueB - valueA;
                });

                // 更新表格显示
                const tableBody = document.getElementById('tableBody');
                if (!tableBody) {
                    console.error('找不到表格体元素');
                    return;
                }

                // 清空表格内容
                tableBody.innerHTML = '';

                // 逐行添加排序后的数据，恢复复选框状态
                articles.forEach((article, index) => {
                    const row = document.createElement('tr');
                    row.style.opacity = '1';
                    row.innerHTML = `
                        <td class="checkbox-column">
                            <input type="checkbox" class="row-checkbox">
                        </td>
                        <td>${index + 1}</td>
                        <td>${article.title || '-'}</td>
                        <td>
                            ${article.authorUrl ? 
                                `<a href="${article.authorUrl}" onclick="event.preventDefault(); openAuthorPage('${article.authorUrl}');">${article.author || '-'}</a>` : 
                                (article.author || '-')
                            }
                        </td>
                        <td>${article.likes || '0'}</td>
                        <td><a href="${article.url}" onclick="event.preventDefault(); openArticle('${article.url}');">看</a></td>
                        <td>${new Date(article.timestamp).toLocaleString()}</td>
                    `;
                    tableBody.appendChild(row);

                    // 恢复复选框状态
                    const checkbox = row.querySelector('.row-checkbox');
                    const originalState = checkedStates.find(state => {
                        return articles[index] === currentArticles[state.index];
                    });
                    if (originalState) {
                        checkbox.checked = originalState.checked;
                    }
                });

                // 更新当前数据
                currentArticles = articles;

                // 更新全选复选框状态
                const allChecked = document.querySelectorAll('.row-checkbox:checked').length === 
                                  document.querySelectorAll('.row-checkbox').length;
                document.getElementById('selectAll').checked = allChecked;

                console.log('排序完成，显示数据量:', articles.length);
            } catch (error) {
                console.error('排序过程出错:', error);
            }
        }

        // 修改 updateTable 函数
        function updateTable(articles) {
            try {
                console.log('开始更新表格，文章数量:', articles.length);
                
                if (!articles || !Array.isArray(articles)) {
                    console.error('无效的文章数据');
                    return;
                }

                const tableBody = document.getElementById('tableBody');
                if (!tableBody) {
                    console.error('找不到表格体元素');
                    return;
                }

                // 清空现有表格内容
                tableBody.innerHTML = '';

                // 逐行添加数据
                articles.forEach((article, index) => {
                    const row = document.createElement('tr');
                    row.style.opacity = '0'; // 始设置为透明

                    // 构建行内容
                    row.innerHTML = `
                        <td class="checkbox-column">
                            <input type="checkbox" class="row-checkbox">
                        </td>
                        <td>${index + 1}</td>
                        <td>${article.title || '-'}</td>
                        <td>
                            ${article.authorUrl ? 
                                `<a href="${article.authorUrl}" onclick="event.preventDefault(); openAuthorPage('${article.authorUrl}');">${article.author || '-'}</a>` : 
                                (article.author || '-')
                            }
                        </td>
                        <td>${article.likes || '0'}</td>
                        <td><a href="${article.url}" onclick="event.preventDefault(); openArticle('${article.url}');">查看</a></td>
                        <td>${new Date(article.timestamp).toLocaleString()}</td>
                    `;

                    // 添加到表格
                    tableBody.appendChild(row);

                    // 强制重排后设置透明度为 1，实现渐入效果
                    requestAnimationFrame(() => {
                        row.style.transition = 'opacity 0.3s ease-in';
                        row.style.opacity = '1';
                    });
                });

                // 更新相状态
                document.getElementById('exportButton').disabled = articles.length === 0;
                document.getElementById('totalCount').textContent = articles.length;
                
                console.log('表格更新完成');

                // 重新应用筛选
                if (document.getElementById('tableFilter').value.trim()) {
                    filterTable();
                }
            } catch (error) {
                console.error('更新表格时出错:', error);
                document.getElementById('status').innerHTML = `更新表格失败: ${error.message}`;
                document.getElementById('status').className = 'error';
            }
        }

        ipcRenderer.on('update-status', (event, message) => {
            document.getElementById('status').innerHTML = message;
        });

        ipcRenderer.on('update-progress', (event, data) => {
            document.getElementById('currentPage').textContent = data.currentPage;
            document.getElementById('totalCount').textContent = data.totalItems;
            
            // 如果有 cookie 备注信息，更新状态显示
            if (data.cookieNote) {
                document.getElementById('status').innerHTML = `正在使用 ${data.cookieNote} 进行抓取...`;
            }
        });

        ipcRenderer.on('scrape-complete', (event, articles) => {
            const button = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const status = document.getElementById('status');
            
            button.disabled = false;
            stopButton.disabled = true;
            status.innerHTML = `${isScrapingStopped ? '已停止抓取，' : ''}共抓取 ${currentArticles.length} 篇文章`;
            status.className = 'success';
            
            document.getElementById('exportButton').disabled = false;
        });

        ipcRenderer.on('scrape-error', (event, error) => {
            const button = document.getElementById('startButton');
            const status = document.getElementById('status');
            
            button.disabled = false;
            status.innerHTML = `抓取失败: ${error}`;
            status.className = 'error';
        });

        // 修改导出功能
        function exportData() {
            // 获取筛选后的数据
            const filteredArticles = getFilteredArticles();
            
            // 发送筛选后的数据进行导出
            ipcRenderer.send('export-data', filteredArticles);
        }

        // 添加获取筛选后数据的函数
        function getFilteredArticles() {
            const filterText = document.getElementById('tableFilter').value.toLowerCase();
            
            // 如果没有筛选文本，返回所有数据
            if (!filterText) {
                return currentArticles;
            }
            
            // 返回符合筛选条件的数据
            return currentArticles.filter(article => {
                // 检查所有需要筛选的字段
                const searchableText = [
                    article.title,
                    article.author,
                    article.likes.toString(),
                    new Date(article.timestamp).toLocaleString()
                ].join(' ').toLowerCase();
                
                return searchableText.includes(filterText);
            });
        }

        // 修改筛选函数，使其同时更新导出按钮状态
        function filterTable() {
            const filterText = document.getElementById('tableFilter').value.toLowerCase();
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');
            let visibleCount = 0;
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let shouldShow = false;
                
                // 检查每个单元格
                for (let cell of cells) {
                    const text = cell.textContent.toLowerCase();
                    if (text.includes(filterText)) {
                        shouldShow = true;
                        break;
                    }
                }
                
                // 根据筛选结果显示或隐藏行
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) {
                    visibleCount++;
                }
            }
            
            // 更新导出按钮状态和提示文本
            const exportButton = document.getElementById('exportButton');
            if (filterText) {
                exportButton.title = `导出筛选后的 ${visibleCount} 条数据`;
            } else {
                exportButton.title = `导出全部 ${currentArticles.length} 条数据`;
            }

            // 重置全选复选框状态
            document.getElementById('selectAll').checked = false;
        }

        // 监听导出完成事件
        ipcRenderer.on('export-complete', (event, path) => {
            document.getElementById('status').innerHTML = `数据已导出到: ${path}`;
            document.getElementById('status').className = 'success';
        });
        
        ipcRenderer.on('export-error', (event, error) => {
            document.getElementById('status').innerHTML = `导出失败: ${error}`;
            document.getElementById('status').className = 'error';
        });

        // 修改新文事件监听
        ipcRenderer.on('new-article', (event, data) => {
            if (isScrapingStopped) return;  // 如果已停止不再添加新文章
            
            const { article, totalCount } = data.data;
            if (!currentArticles.some(a => a.url === article.url)) {
                addArticleToTable(article);
                document.getElementById('status').innerHTML = `在抓取中... 已获取 ${totalCount} 篇文章`;
            }
        });

        // 修改 addArticleToTable 函数
        function addArticleToTable(article) {
            // 检查是否已存在相同的文章
            if (currentArticles.some(a => a.url === article.url)) {
                return;
            }

            const tableBody = document.getElementById('tableBody');
            const row = document.createElement('tr');
            const index = currentArticles.length + 1;
            
            row.innerHTML = `
                <td class="checkbox-column">
                    <input type="checkbox" class="row-checkbox">
                </td>
                <td>${index}</td>
                <td>${article.title || '-'}</td>
                <td>
                    ${article.authorUrl ? 
                        `<a href="${article.authorUrl}" onclick="event.preventDefault(); openAuthorPage('${article.authorUrl}');">${article.author || '-'}</a>` : 
                        (article.author || '-')
                    }
                </td>
                <td>${article.likes || '0'}</td>
                <td><a href="${article.url}" onclick="event.preventDefault(); openArticle('${article.url}');">查看</a></td>
                <td>${new Date(article.timestamp).toLocaleString()}</td>
            `;
            
            // 添加关键词到文章数据中
            article.keyword = document.getElementById('keywordInput').value.trim();
            
            // 添加到当前文章数组
            currentArticles.push(article);
            
            // 加渐入动画效果
            row.style.opacity = '0';
            tableBody.appendChild(row);
            
            // 触发重排以启用动画
            void row.offsetHeight;
            row.style.transition = 'opacity 0.3s ease-in';
            row.style.opacity = '1';
            
            // 滚动到底部
            tableBody.parentElement.scrollTop = tableBody.parentElement.scrollHeight;
            
            // 更新统计数据
            document.getElementById('totalCount').textContent = currentArticles.length;
        }

        // 修改 cookie 保存函数
        function saveCookie() {
            const cookieInput = document.getElementById('cookieInput').value.trim();
            const cookieNote = document.getElementById('cookieNote').value.trim();
            const cookieStatus = document.getElementById('cookieStatus');
            
            if (!cookieInput) {
                cookieStatus.textContent = '请输入 cookie';
                cookieStatus.className = 'cookie-status error';
                return;
            }

            try {
                // 发送到主进程保存 cookie
                ipcRenderer.send('save-cookie', {
                    cookieString: cookieInput,
                    note: cookieNote
                });
                
                // 清空输入框
                document.getElementById('cookieInput').value = '';
                document.getElementById('cookieNote').value = '';
            } catch (error) {
                cookieStatus.textContent = '保存失败: ' + error.message;
                cookieStatus.className = 'cookie-status error';
            }
        }

        // 删除重复的 deleteCookie 函数，只保留一个版本
        function deleteCookie(index) {
            try {
                ipcRenderer.send('delete-cookie', index);
                // 立即更新视觉反馈
                const group = document.querySelector(`.cookie-group:nth-child(${index + 1})`);
                if (group) {
                    group.style.opacity = '0.5';
                }
            } catch (error) {
                const cookieStatus = document.getElementById('cookieStatus');
                cookieStatus.textContent = '删除失败: ' + error.message;
                cookieStatus.className = 'cookie-status error';
            }
        }

        // 修改清除 cookie 函数
        function clearCookie() {
            try {
                ipcRenderer.send('clear-cookie');
                // 立即清空列表显示
                const cookieList = document.getElementById('cookieList');
                cookieList.innerHTML = '<div class="cookie-item">正在清除...</div>';
            } catch (error) {
                const cookieStatus = document.getElementById('cookieStatus');
                cookieStatus.textContent = '清除失败: ' + error.message;
                cookieStatus.className = 'cookie-status error';
            }
        }

        // 修改 cookie 保存结果的监听器
        ipcRenderer.on('cookie-saved', (event, data) => {
            const cookieStatus = document.getElementById('cookieStatus');
            if (data.success) {
                cookieStatus.textContent = `Cookie 保存成功 (共 ${data.cookiesCount} 组)`;
                cookieStatus.className = 'cookie-status success';
                updateCookieList(data);
            } else {
                cookieStatus.textContent = 'Cookie 保存失败';
                cookieStatus.className = 'cookie-status error';
            }
        });

        // 修改 cookie 删结果的监听器
        ipcRenderer.on('cookie-deleted', (event, data) => {
            const cookieStatus = document.getElementById('cookieStatus');
            if (data.success) {
                cookieStatus.textContent = `Cookie 组删除成功 (剩余 ${data.cookiesCount} 组)`;
                cookieStatus.className = 'cookie-status success';
                updateCookieList(data);
            } else {
                cookieStatus.textContent = 'Cookie 组删除失败';
                cookieStatus.className = 'cookie-status error';
            }
        });

        // 修改 cookie 清除结果的监听器
        ipcRenderer.on('cookie-cleared', (event, data) => {
            const cookieStatus = document.getElementById('cookieStatus');
            if (data.success) {
                cookieStatus.textContent = 'Cookie 已清除';
                cookieStatus.className = 'cookie-status success';
                updateCookieList({
                    cookiesList: [],
                    cookieNotes: [],
                    cookiesCount: 0
                });
            } else {
                cookieStatus.textContent = 'Cookie 清除失败';
                cookieStatus.className = 'cookie-status error';
            }
        });

        // 添加打文章的函数
        function openArticle(url) {
            ipcRenderer.send('open-article', url);
        }

        // 修 cookie 列表显示函数
        function updateCookieList(data) {
            const cookieList = document.getElementById('cookieList');
            const { cookiesList, cookieNotes, cookiesCount } = data;
            
            if (!cookiesList || cookiesList.length === 0) {
                cookieList.innerHTML = '<div class="cookie-item">暂无 Cookie</div>';
                return;
            }

            // 生成所有 cookie 组的 HTML
            let cookieGroupsHtml = '';
            for (let i = 0; i < cookiesList.length; i++) {
                const note = cookieNotes[i] || '';
                cookieGroupsHtml += `
                    <div class="cookie-group" style="margin-bottom: 10px; display: block;">
                        <div class="cookie-group-header">
                            <label class="cookie-select">
                                <input type="checkbox" class="cookie-checkbox" 
                                    data-index="${i}" 
                                    onchange="handleCookieSelect(${i})" 
                                    ${i === 0 ? 'checked' : ''}>
                                <span>Cookie ${i + 1}${note ? `: ${note}` : ''}</span>
                            </label>
                            <button class="delete-cookie-btn" onclick="deleteCookie(${i})">删除</button>
                        </div>
                    </div>
                `;
            }

            // 更新列���内容
            cookieList.innerHTML = cookieGroupsHtml;

            // 更新状显示
            const cookieStatus = document.getElementById('cookieStatus');
            if (cookieStatus) {
                cookieStatus.textContent = `当前共有 ${cookiesCount} 组 Cookie`;
                cookieStatus.className = 'cookie-status';
            }
        }

        // 添加 cookie 选择处理函数
        function handleCookieSelect(index) {
            const checkboxes = document.querySelectorAll('.cookie-checkbox');
            checkboxes.forEach((checkbox, i) => {
                if (i !== index) {
                    checkbox.checked = false;
                }
            });
            
            // 保存选中的 cookie 索引
            selectedCookieIndex = index;
        }

        // 在页面加载时获取当前的 cookie 列表
        window.addEventListener('DOMContentLoaded', () => {
            ipcRenderer.send('get-cookies');
        });

        // 修改 cookie 列表更新的监听器
        ipcRenderer.on('cookies-updated', (event, data) => {
            updateCookieList(data);
        });

        // 添加删除 cookie 结果的监听器
        ipcRenderer.on('cookie-deleted', (event, data) => {
            const cookieStatus = document.getElementById('cookieStatus');
            if (data.success) {
                cookieStatus.textContent = `Cookie 组删除成功 (剩余 ${data.cookiesCount} 组)`;
                cookieStatus.className = 'cookie-status success';
                updateCookieList(data);
            } else {
                cookieStatus.textContent = 'Cookie 组删除失败';
                cookieStatus.className = 'cookie-status error';
            }
        });

        // 添加打开作者主页的函数
        function openAuthorPage(url) {
            ipcRenderer.send('open-author-page', url);
        }

        // 修改停止抓取函数
        function stopScrape() {
            isScrapingStopped = true;
            document.getElementById('stopButton').disabled = true;
            document.getElementById('startButton').disabled = true;  // 暂禁用开始按钮
            document.getElementById('status').innerHTML = '<span class="loading">正在停止抓取...</span>';
            ipcRenderer.send('stop-scrape');
        }

        // 添加筛选函数
        function filterTable() {
            const filterText = document.getElementById('tableFilter').value.toLowerCase();
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let shouldShow = false;
                
                // 检查每个单元格
                for (let cell of cells) {
                    const text = cell.textContent.toLowerCase();
                    if (text.includes(filterText)) {
                        shouldShow = true;
                        break;
                    }
                }
                
                // 根据筛选结果显示或隐藏行
                row.style.display = shouldShow ? '' : 'none';
            }
        }

        // 监听筛选输入框的输入事件
        document.getElementById('tableFilter').addEventListener('input', filterTable);

        // 添加 cookie 区域折叠函数
        function toggleCookieSection() {
            const header = document.querySelector('.cookie-header');
            const content = document.getElementById('cookieContent');
            
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // 添加导入数据函数
        function importData() {
            ipcRenderer.send('import-data');
        }

        // 修改导入完成的监听器
        ipcRenderer.on('import-complete', (event, articles) => {
            try {
                console.log('收到导入数据:', articles);
                if (!articles || !Array.isArray(articles)) {
                    throw new Error('导入的数据格式不正确');
                }

                // 更新当前文章数组
                currentArticles = articles;

                // 使用现有的 updateTable 函数来更新表格
                updateTable(articles);

                // 更新状态
                document.getElementById('status').innerHTML = `成功导入 ${articles.length} 篇文章`;
                document.getElementById('status').className = 'success';
                document.getElementById('exportButton').disabled = false;

                console.log('导入数据显示完成');
            } catch (error) {
                console.error('处理导入数据时出错:', error);
                document.getElementById('status').innerHTML = `导入数据处理失败: ${error.message}`;
                document.getElementById('status').className = 'error';
            }
        });

        // 添加导入错的监听器
        ipcRenderer.on('import-error', (event, error) => {
            document.getElementById('status').innerHTML = `导入失败: ${error}`;
            document.getElementById('status').className = 'error';
        });

        // 全选/取消全选功能
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const isChecked = selectAllCheckbox.checked;
            
            rowCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                if (row.style.display !== 'none') {  // 只处理可见行
                    checkbox.checked = isChecked;
                }
            });
        }

        // 修改运行选中操作的函数
        async function runSelectedActions() {
            // 获取选中的行
            const selectedRows = Array.from(document.querySelectorAll('.row-checkbox:checked'));
            if (selectedRows.length === 0) {
                document.getElementById('status').innerHTML = '请先选择要操作的文章';
                document.getElementById('status').className = 'error';
                return;
            }

            // 获取选中的操作
            const actions = {
                follow: document.getElementById('followAction').checked,
                like: document.getElementById('likeAction').checked,
                favorite: document.getElementById('favoriteAction').checked
            };

            if (!actions.follow && !actions.like && !actions.favorite) {
                document.getElementById('status').innerHTML = '请选择要执行的操作';
                document.getElementById('status').className = 'error';
                return;
            }

            // 切换按钮状态
            document.getElementById('runActionsButton').disabled = true;
            document.getElementById('stopActionsButton').disabled = false;

            // 获取选中行的链接 - 修改选择器以获取正确的链接
            const selectedUrls = selectedRows.map(checkbox => {
                const row = checkbox.closest('tr');
                // 修改这里：获取第6列（链接列）中的链接地址
                const linkCell = row.cells[5]; // 第6列
                const link = linkCell.querySelector('a');
                return link.getAttribute('href');
            }).filter(url => url); // 过滤掉无效链接

            // 获取选中的 cookie 索引
            const selectedCheckbox = document.querySelector('.cookie-checkbox:checked');
            const cookieIndex = selectedCheckbox ? parseInt(selectedCheckbox.getAttribute('data-index')) : 0;

            try {
                // 发送请求到主进程执行操作
                ipcRenderer.send('run-actions', {
                    urls: selectedUrls,
                    actions: actions,
                    cookieIndex: cookieIndex
                });

                document.getElementById('status').innerHTML = '正在执行操作...';
                document.getElementById('status').className = '';
            } catch (error) {
                document.getElementById('status').innerHTML = `执行操作失败: ${error.message}`;
                document.getElementById('status').className = 'error';
                document.getElementById('runActionsButton').disabled = false;
                document.getElementById('stopActionsButton').disabled = true;
            }
        }

        // 添加停止运行函数
        function stopSelectedActions() {
            document.getElementById('stopActionsButton').disabled = true;
            document.getElementById('runActionsButton').disabled = false;
            document.getElementById('status').innerHTML = '正在停止操作...';
            ipcRenderer.send('stop-actions');
        }

        // 添加操作完成的监听器
        ipcRenderer.on('action-complete', (event, result) => {
            document.getElementById('runActionsButton').disabled = false;
            document.getElementById('stopActionsButton').disabled = true;
            document.getElementById('status').innerHTML = `操作完成: ${result.success}/${result.total} 成功`;
            document.getElementById('status').className = result.success === result.total ? 'success' : 'warning';
        });

        // 添加操作错误的监听器
        ipcRenderer.on('action-error', (event, error) => {
            document.getElementById('runActionsButton').disabled = false;
            document.getElementById('stopActionsButton').disabled = true;
            document.getElementById('status').innerHTML = `执行操作失败: ${error}`;
            document.getElementById('status').className = 'error';
        });

        // 添加操作进度的监听器
        ipcRenderer.on('action-progress', (event, data) => {
            document.getElementById('status').innerHTML = 
                `正在执行操作... (${data.current}/${data.total}) 当前处理: ${data.url}`;
        });

        // 修改验证码检测的监听器
        ipcRenderer.on('captcha-detected', (event, data) => {
            document.getElementById('runActionsButton').disabled = false;
            document.getElementById('stopActionsButton').disabled = true;
            document.getElementById('status').innerHTML = `检测到验证码，已运行到第 ${data.current}/${data.total} 个，还剩 ${data.remaining} 个未运行`;
            document.getElementById('status').className = 'error';
            
            // 显示弹窗通知
            alert(`检测到验证码！\n已运行到第 ${data.current}/${data.total} 个\n还剩 ${data.remaining} 个未运行\n请手动操作后重试！`);
        });
    </script>
</body>
</html>
